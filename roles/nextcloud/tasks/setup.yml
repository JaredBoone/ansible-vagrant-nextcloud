---
# task file for JaredBoone.nextcloud

# - name: ensure epel-relase and webtatic yum repos are installed
#   yum:
#     name:
#       - epel-release
#       - https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
#     state: present
#   when: nextcloud_manage_yum_repos

# - name: ensure required packages are installed
#   yum:
#     name: 
#       - crontabs
#       - libselinux-python
#       - policycoreutils-python
#       - lbzip2-utils
#       - openssl
#       - libreoffice
#       - jq

- name: setup - ensure php options are set
  lineinfile:
    path: /etc/php.ini
    regexp: '^{{ item.option }}'
    line: '{{ item.option }} = {{ item.value }}'    
  with_items:
    - { option: 'expose_php', value: 'Off' }
    - { option: 'upload_tmp_dir', value: '{{ nextcloud_tmp }}' }
  notify:
    - reload php-fpm
    - reload httpd
    
- name: setup - ensure pdo_pgsql.ini config is present
  copy:
    src: pdo_pgsql.ini
    dest: /etc/php.d/30-pdo_pgsql.ini

- name: setup - ensure alias for the occ command exists in /root/.bashrc
  lineinfile:
    name: /root/.bashrc
    line: "alias occ='sudo -u apache {{ nextcloud_web_root }}/occ'"

- name: setup - ensure {{ nextcloud_web_root }} is present
  file:
    name: '{{ nextcloud_web_root }}'
    state: directory
  register: new_installation

- name: setup - ensure .htaccess is present for caldav/carddav
  copy:
    src: htaccess
    dest: '{{ apache_document_root }}/.htaccess'
    mode: 0644
    owner: apache
    group: apache
  notify: reload httpd    

- name: ensure php-fpm www.conf settings are correct
  lineinfile:
    path: /etc/php-fpm.d/www.conf
    regexp: '^;?{{ item.name }}\s*='
    line: '{{ item.name }} = {{ item.value }}'
  with_items:
    - { name: user, value: apache }
    - { name: group, value: apache }
    - { name: clear_env, value: 'no' }
  notify: reload php-fpm

- name: setup - ensure the nextcloud cronjob exists and runs every 15 min
  cron:
    name: nextcloud
    minute: 15
    user: apache
    job: 'php -f {{ nextcloud_web_root | quote }}/cron.php'
    cron_file: 'nextcloud'

- name: setup - logrotate
  template:
    src: logrotate.nextcloud
    dest: /etc/logrotate.d/nextcloud
    owner: root
    group: root
    mode: 0644

# - name: ensure options are set in .user.ini
#   lineinfile:
#     path: '{{ nextcloud_web_root }}/.user.ini'
#     regexp: '^{{ item.option }}'
#     line: '{{ item.option }}={{ item.value }}'
#   with_items:
#     - { option: 'upload_max_filesize', value: '{{ nextcloud_max_upload_size }}' } 
#     - { option: 'post_max_size', value: '{{ nextcloud_max_upload_size }}' }

